
> appcomidassemana@1.0.0 test
> jest tests/shopping-list-calculation.test.ts

  console.log
    [dotenv@17.2.3] injecting env (5) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    ‚úì New client connected to PostgreSQL database

      at BoundPool.<anonymous> (src/config/database.ts:17:11)

  console.log
    DEBUG: getResolvedDiners bulk query: { userId: undefined, mealType: undefined, count: 0, rows: [] }

      at DatabaseService.getResolvedDiners (src/services/DatabaseService.ts:593:15)
          at async Promise.all (index 0)

  console.log
    ‚úì New client connected to PostgreSQL database

      at BoundPool.<anonymous> (src/config/database.ts:17:11)

  console.log
    DEBUG: getResolvedDiners bulk query: { userId: undefined, mealType: undefined, count: 0, rows: [] }

      at DatabaseService.getResolvedDiners (src/services/DatabaseService.ts:593:15)
          at async Promise.all (index 1)

  console.log
    DEBUG: getResolvedDiners bulk query: { userId: undefined, mealType: undefined, count: 0, rows: [] }

      at DatabaseService.getResolvedDiners (src/services/DatabaseService.ts:593:15)
          at async Promise.all (index 0)

  console.log
    DEBUG: Fetched meals: [
      {
        "id": "50713733-d766-4dec-95b5-695a23ff7ef4",
        "menuPlanId": "4d6d075c-0f51-4313-ad4a-1ac4249abc8b",
        "dayOfWeek": "thursday",
        "mealType": "lunch",
        "hasCustomDiners": false,
        "createdAt": "2025-11-21T12:21:17.369Z",
        "updatedAt": "2025-11-21T12:21:17.369Z",
        "userId": "4a92a900-9641-4ed1-b086-c3552f339531",
        "diners": [],
        "dishes": [
          {
            "id": "367e8555-dbfa-4e7c-8666-4440d045b661",
            "mealId": "50713733-d766-4dec-95b5-695a23ff7ef4",
            "name": "Ensalada Mixta",
            "description": "Ensalada fresca con lechuga, tomate, cebolla, aceitunas, at√∫n, huevo duro y aceite de oliva",
            "ingredients": [
              "Lechuga",
              "Tomate",
              "Cebolla",
              "Aceitunas",
              "At√∫n",
              "Huevo duro",
              "Aceite de oliva"
            ],
            "course": "dessert"
          },
          {
            "id": "90807e2a-b285-471a-8874-8f03df217ce8",
            "mealId": "50713733-d766-4dec-95b5-695a23ff7ef4",
            "name": "Paella Valenciana",
            "description": "Arroz con pollo, conejo, jud√≠as verdes, garrof√≥n, tomate, azafr√°n y aceite de oliva",
            "ingredients": [
              "Arroz",
              "Pollo",
              "Conejo",
              "Jud√≠as verdes",
              "Garrof√≥n",
              "Tomate",
              "Azafr√°n",
              "Aceite de oliva"
            ],
            "course": "main"
          }
        ]
      }
    ]

      at Object.<anonymous> (tests/shopping-list-calculation.test.ts:121:17)

FAIL tests/shopping-list-calculation.test.ts (19.103 s)
  Shopping List Calculation with Bulk Diners
    ‚úï should correctly resolve diners for shopping list generation (5216 ms)
    ‚úï should reflect updated preferences in shopping list (dynamic resolution) (3458 ms)

  ‚óè Shopping List Calculation with Bulk Diners ‚Ä∫ should correctly resolve diners for shopping list generation

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      74 |         const dinnerMeal = meals.find(m => m.mealType === 'dinner');
      75 |
    > 76 |         expect(lunchMeal?.diners).toHaveLength(1);
         |                                   ^
      77 |         expect(dinnerMeal?.diners).toHaveLength(2);
      78 |
      79 |         // Now generate shopping list (simulated via AIService -> MockAIService)

      at Object.<anonymous> (tests/shopping-list-calculation.test.ts:76:35)

  ‚óè Shopping List Calculation with Bulk Diners ‚Ä∫ should reflect updated preferences in shopping list (dynamic resolution)

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 0
    Received array:  []

      123 |
      124 |         // This expectation will fail if we use snapshot, pass if we use dynamic
    > 125 |         expect(lunchMeal?.diners).toHaveLength(2);
          |                                   ^
      126 |         expect(lunchMeal?.diners.map(d => d.name)).toContain('Member 2');
      127 |     });
      128 | });

      at Object.<anonymous> (tests/shopping-list-calculation.test.ts:125:35)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 2 total
Snapshots:   0 total
Time:        21.322 s
Ran all test suites matching /tests\/shopping-list-calculation.test.ts/i.

  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "Client removed from pool".

      25 | // Evento de eliminaci√≥n de cliente
      26 | pool.on('remove', (client) => {
    > 27 |   console.log('Client removed from pool');
         |           ^
      28 | });
      29 |
      30 | // Funci√≥n para verificar la conexi√≥n

      at console.log (node_modules/@jest/console/build/CustomConsole.js:141:10)
      at BoundPool.<anonymous> (src/config/database.ts:27:11)
      at Connection.<anonymous> (node_modules/pg-pool/index.js:174:15)
      at Socket.<anonymous> (node_modules/pg/lib/connection.js:62:12)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "Client removed from pool".

      25 | // Evento de eliminaci√≥n de cliente
      26 | pool.on('remove', (client) => {
    > 27 |   console.log('Client removed from pool');
         |           ^
      28 | });
      29 |
      30 | // Funci√≥n para verificar la conexi√≥n

      at console.log (node_modules/@jest/console/build/CustomConsole.js:141:10)
      at BoundPool.<anonymous> (src/config/database.ts:27:11)
      at Connection.<anonymous> (node_modules/pg-pool/index.js:174:15)
      at Socket.<anonymous> (node_modules/pg/lib/connection.js:62:12)

