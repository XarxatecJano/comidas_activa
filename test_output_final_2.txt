
> appcomidassemana@1.0.0 test
> jest tests/shopping-list-calculation.test.ts

  console.log
    [dotenv@17.2.3] injecting env (5) from .env -- tip: ⚙️  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    ✓ New client connected to PostgreSQL database

      at BoundPool.<anonymous> (src/config/database.ts:17:11)

  console.log
    ✓ New client connected to PostgreSQL database

      at BoundPool.<anonymous> (src/config/database.ts:17:11)

  console.log
    DEBUG: Fetched meals: [
      {
        "id": "c0a0f371-9bce-4d27-b162-bcca5ff85e26",
        "menuPlanId": "45b2f909-1e0d-4b41-9747-18e0a9dbbe58",
        "dayOfWeek": "thursday",
        "mealType": "lunch",
        "hasCustomDiners": false,
        "createdAt": "2025-11-21T12:20:22.203Z",
        "updatedAt": "2025-11-21T12:20:22.203Z",
        "userId": "c9a8b1c8-47d5-4323-b2d4-6e7cef335c07",
        "diners": [],
        "dishes": [
          {
            "id": "beaf8acf-b45d-4869-95e3-18213cd0d1ee",
            "mealId": "c0a0f371-9bce-4d27-b162-bcca5ff85e26",
            "name": "Ensalada Mixta",
            "description": "Ensalada fresca con lechuga, tomate, cebolla, aceitunas, atún, huevo duro y aceite de oliva",
            "ingredients": [
              "Lechuga",
              "Tomate",
              "Cebolla",
              "Aceitunas",
              "Atún",
              "Huevo",
              "Aceite de oliva virgen extra"
            ],
            "course": "dessert"
          },
          {
            "id": "0be3300e-6e46-4197-becd-d90f9d826a37",
            "mealId": "c0a0f371-9bce-4d27-b162-bcca5ff85e26",
            "name": "Paella Valenciana",
            "description": "Arroz con verduras de temporada, pollo, conejo y judías verdes cocinado con azafrán y aceite de oliva virgen extra",
            "ingredients": [
              "Arroz bomba",
              "Pollo",
              "Conejo",
              "Judías verdes",
              "Azafrán",
              "Aceite de oliva virgen extra"
            ],
            "course": "main"
          }
        ]
      }
    ]

      at Object.<anonymous> (tests/shopping-list-calculation.test.ts:121:17)

FAIL tests/shopping-list-calculation.test.ts (12.516 s)
  Shopping List Calculation with Bulk Diners
    ✕ should correctly resolve diners for shopping list generation (3392 ms)
    ✕ should reflect updated preferences in shopping list (dynamic resolution) (1817 ms)

  ● Shopping List Calculation with Bulk Diners › should correctly resolve diners for shopping list generation

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      74 |         const dinnerMeal = meals.find(m => m.mealType === 'dinner');
      75 |
    > 76 |         expect(lunchMeal?.diners).toHaveLength(1);
         |                                   ^
      77 |         expect(dinnerMeal?.diners).toHaveLength(2);
      78 |
      79 |         // Now generate shopping list (simulated via AIService -> MockAIService)

      at Object.<anonymous> (tests/shopping-list-calculation.test.ts:76:35)

  ● Shopping List Calculation with Bulk Diners › should reflect updated preferences in shopping list (dynamic resolution)

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 0
    Received array:  []

      123 |
      124 |         // This expectation will fail if we use snapshot, pass if we use dynamic
    > 125 |         expect(lunchMeal?.diners).toHaveLength(2);
          |                                   ^
      126 |         expect(lunchMeal?.diners.map(d => d.name)).toContain('Member 2');
      127 |     });
      128 | });

      at Object.<anonymous> (tests/shopping-list-calculation.test.ts:125:35)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 2 total
Snapshots:   0 total
Time:        13.421 s, estimated 15 s
Ran all test suites matching /tests\/shopping-list-calculation.test.ts/i.

  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "Client removed from pool".

      25 | // Evento de eliminación de cliente
      26 | pool.on('remove', (client) => {
    > 27 |   console.log('Client removed from pool');
         |           ^
      28 | });
      29 |
      30 | // Función para verificar la conexión

      at console.log (node_modules/@jest/console/build/CustomConsole.js:141:10)
      at BoundPool.<anonymous> (src/config/database.ts:27:11)
      at Connection.<anonymous> (node_modules/pg-pool/index.js:174:15)
      at Socket.<anonymous> (node_modules/pg/lib/connection.js:62:12)


  ●  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "Client removed from pool".

      25 | // Evento de eliminación de cliente
      26 | pool.on('remove', (client) => {
    > 27 |   console.log('Client removed from pool');
         |           ^
      28 | });
      29 |
      30 | // Función para verificar la conexión

      at console.log (node_modules/@jest/console/build/CustomConsole.js:141:10)
      at BoundPool.<anonymous> (src/config/database.ts:27:11)
      at Connection.<anonymous> (node_modules/pg-pool/index.js:174:15)
      at Socket.<anonymous> (node_modules/pg/lib/connection.js:62:12)

